# Imagen Genetics Lab — План рефакторинга и архитектура весов

## 1. Оценка текущей сложности

- `pipeline.py` выступает монолитным оркестратором: он одновременно инициирует почти все сервисы (DualScorer, Catalog, CharacterLibrary, SceneBuilder, PromptComposer, EmbeddingCache, StyleFeedback и др.), управляет загрузкой профилей весов и жизненным циклом Ollama/Imagen. Из-за этого модуль трудно тестировать, а замена отдельных стадий пайплайна требует каскадных правок.
- `SceneBuilder` объединяет в себе выбор шаблонов, случайность, учёт обратной связи, работу с персонажами и каталоги стилей. Он тесно связан с хранилищем данных и не имеет явной модели «гена»/слота, из‑за чего расширение ассортимента опций приводит к лавинообразным правкам.
- `PromptComposer` смешивает политику текста, SFW-настройки и работу с Ollama. Попытки переиспользовать его только для макро/мезо сигналов ведут к дублированию логики и ошибкам синхронизации.
- Текущий `config.yaml` перегружен и не отражает иерархию macro/meso/micro регуляторов. Пользователю трудно понять, какие параметры отвечают за поведение, а какие — за инфраструктурные детали.
- `DualScorer` содержит логику загрузки моделей CLIP/NSFW, подсчёта композитных метрик, запись в SQLite/JSONL и управление эмбеддингами. Это превращает модуль в «второй пайплайн» внутри пайплайна.
- Хранилище (`storage.py`, JSONL) записывает только промпты и общие параметры. Нет нормализованных таблиц для микро/мезо метрик, отсутствуют ссылки на гены и веса. Аналитика и обучение на истории затруднены.

## 2. Слои новой архитектуры

| Слой | Ответственность |
|------|-----------------|
| `io.json` | Загрузка JSON описаний стилей/персонажей, валидация схем, миграции версий. |
| `scene.builder` | Сборка pre-prompt из стиля, персонажа и профиля весов. Применение bias и выбор конкретных опций. |
| `bias.engine` | Преобразование macro/meso регуляторов и профилей в вероятности выбора генов, применение правил и ограничений. |
| `caption.ollama` | Минимальная обёртка над Ollama: принимает макро/мезо сигнал и факты сцены, возвращает ≤2 предложения. |
| `image.imagen` | Изолированный адаптер Imagen API. |
| `scoring.core` | Вычисление микро-метрик, построение meso агрегатов, финальный fitness. |
| `db.repo` | Работа с БД (runs, prompts, scores, profiles, gene_stats). |
| `ga.engine` | Генетический алгоритм, оперирующий только профилями и агрегатами, без прямого доступа к микро метрикам. |

Оркестратор остаётся тонким координатором (`pipeline.py`), который связывает слои в последовательности `scene → caption → image → scoring → db` и управляет режимами запуска.

## 3. JSON-источники стилей и персонажей

### 3.1 Общие требования

- Каждый JSON содержит поля `schema_version` и `id_namespace`, формирующие уникальный идентификатор вида `style:retro_watercolor@v1`.
- Файлы валидируются через JSON Schema или pydantic-модели. Ошибки выводятся человеку в читаемом виде.
- Поддерживается миграция версий: на диск можно сохранять файлы старых схем, конвертер обновляет их до актуальной версии или выдаёт подсказки.

### 3.2 Наследование и мердж-правила

- Поля `extends` и `merge` описывают цепочку наследования.
- Значение `merge` задаёт режимы: `override`, `append_unique`, `remove`.
- При сборке pre-prompt движок применяет правила в фиксированном порядке: базовый стиль → расширения → локальные правки пользователя.

### 3.3 Онтологии и ссылки

- Каталоги (`poses.json`, `lighting.json`, `palettes.json`, `wardrobe_taxonomy.json` и др.) — единственный источник правды.
- В стилях/персонажах указываются ссылки на идентификаторы каталога и локальные bias/constraints, а не произвольный текст.
- Каталоги версионируются аналогично стилям: `catalog:poses@2024-05-01`.

### 3.4 Пример структуры файла стиля

```json
{
  "schema_version": 2,
  "id_namespace": "style:retro_watercolor@v1",
  "extends": "style:watercolor_base@v1",
  "merge": {
    "scene_notes": "append_unique",
    "bias_rules": "append_unique"
  },
  "macro_bias": {
    "gloss_priority": 0.65,
    "illustration_strength": 0.9,
    "retro_authenticity": 0.8
  },
  "meso_templates": {
    "palette": ["palette:sunset_rust"],
    "lighting": ["lighting:soft_backlight", "lighting:studio_key"],
    "pose_classes": ["pose:pinup_s_curve", "pose:sitting_tease"]
  },
  "bias_rules": [
    "when era==80s and coverage<0.4 -> increase wardrobe:leotard x1.5",
    "when sfw_level>0.7 -> ban wardrobe:micro_bikini"
  ],
  "constraints": {
    "coverage_min": 0.4,
    "gloss_max": 0.85
  }
}
```

## 4. Bias-движок и профили

- **Macro уровень:** 9 глобальных регуляторов (`sfw_level`, `era_target`, `focus_mode`, `gloss_priority`, `coverage_target`, `illustration_strength`, `novelty_preference`, `lighting_softness`, `retro_authenticity`).
- **Meso уровень:** агрегаты, описывающие группы микро-метрик (`fitness_style`, `fitness_body_focus`, `fitness_era_match`, `fitness_coverage`, `fitness_alignment`, `fitness_cleanliness`, `fitness_novelty`). Коэффициенты агрегатов задаются в конфиге и профилях.
- **Micro уровень:** атомарные метрики (style_core, gloss_intensity, coverage_ratio, thigh_focus, chest_focus, clip_prompt_alignment, ai_artifacts и др.) доступны только скореру и аналитике.
- Профиль пользователя — компактный вектор 10–12 доменных регуляторов (macro + ключевые meso коэффициенты). Пользователь выбирает `profile_id`, `style_preset`, `character_preset` и корректирует отдельные регуляторы.
- При запуске bias-движок смешивает профиль пользователя, bias стиля и персонажа, а также статистику из БД (EMA по генам). Итог — вероятности для каждого гена и список активных правил/ограничений.
- Bias-движок парсит mini-DSL правил и применяет их к вероятностям (умножение, clamp, запрет опций).
- Между макро/мезо сигналами и генами работает слой Observed→Desired: таблица, где каждому желаемому исходу (`coverage_target`, `gloss_priority`, `retro_authenticity` и т.п.) сопоставлены конкретные гены, коэффициенты и hard-constraints. Это заменяет разрозненную логику ручной настройки.
- Для предотвращения «цементации» весов применяется ограничение диапазона вероятностей (например, 0.05–0.8) и температурное сглаживание.

## 5. Pre-prompt и Caption

1. `scene.builder` выбирает конкретные опции (pose, lighting, palette, wardrobe, background, mood) на основе bias-движка и возвращает структурированный объект сцены. В объекте фиксируются:
   - выбранные гены с вероятностями и ссылками на каталоги;
   - применённые правила/ограничения и конфликты;
   - snapshot macro/meso регуляторов.
2. В Ollama передаётся JSON-пэйлоад: краткое описание стиля, сводка персонажа, факты сцены, топ-5 макро/мезо сигналов (название + значение). Микро-метрики не пробрасываются.
3. Системный промпт Ollama описывает задачу и ограничение на длину (≤2 предложения), запрет на повтор стиля, отсутствие новых регуляторов.

## 6. Генерация Imagen

- `image.imagen` — thin wrapper: принимает caption, параметры модели, seed, возвращает JPEG + метаданные (seed, steps, sampler).
- Версии модели фиксируются в конфиге и записываются в БД (`imagen_version`).

## 7. Скоринг и агрегаты

- `scoring.core` вычисляет полный набор micro метрик и агрегирует meso:
  - `fitness_style = 0.5·style_core + 0.3·gloss_intensity + 0.2·softness_blur`
  - `fitness_body_focus = 0.4·chest_focus + 0.4·thigh_focus + 0.2·pose_suggestiveness`
  - и т.д. по списку в задании.
- `clip_prompt_alignment`, `identity_consistency`, `ai_artifacts`, `visual_noise_level` получают температурные коэффициенты `τ`, заданные в конфиге скорера.
- Микро метрики остаются внутренним слоем аналитики и не выставляются пользователю напрямую.

## 8. База данных

- **Таблицы:**
  - `runs(session_id, cfg_json, macro_snapshot, meso_snapshot, profile_id, mode, seed, conflicts)`
  - `prompts(path, session_id, prompt, params_json, gene_choices_json, option_probs_json, caption, imagen_version, fitness, parents, op, gen, indiv, created_at)`
  - `scores(prompt_path, micro_json, meso_json, fitness_visual, fitness_body_focus, fitness_alignment, fitness_cleanliness, fitness_era_match, fitness_novelty, clip_alignment, ai_artifacts, created_at)`
  - `profiles(profile_id, vector_json, updated_at)`
  - `gene_stats(gene_id, ema_fitness, count, last_seen_ts, confidence)`
- Индексы по `session_id`, `fitness`, `gene_id`.
- Ошибки генерации (`no_image`) логируются в `prompts` с `fitness=0` и флагом `status`.

## 9. Обучение предпочтений

- После каждой сессии обновляется EMA для каждого гена по результатам `fitness`.
- При следующем запуске bias-движок использует EMA как мягкий bias.
- В течение одной сессии действует penalty-память (in-memory) для комбинаций, которые приводили к ошибкам.

## 10. Режимы запуска

- **Normal:** полный цикл с скорингом и обновлением статистики.
- **Evolve:** GA стартует с лучших индивидуумов из БД (`--resume-best`), выполняет мутацию на уровне профилей.
- **Dry-run:** пропускает скоринг, использует замороженные профили и gene_stats, пишет только `runs` и `prompts`.
- Все режимы фиксируют `seed`, версии стилей/персонажей и профиля.

## 11. Конфигурация

Главный конфиг (YAML/JSONC) содержит секции:

- `presets`: `style_preset`, `character_preset`, `profile_id`.
- `macro_weights`: значения 0..1 с комментариями.
- `meso_aggregates`: коэффициенты для агрегатов.
- `bias_rules`: декларативные правила влияния регуляторов на гены.
- `runtime`: параметры Ollama/Imagen, `batch`, `population`, `generations`, `dry_run_no_scoring`, `resume_best`.
- `scoring`: температуры, перцентили, флаги агрегации.
- `storage`: пути к БД, артефактам, логам.

Конфиг может ссылаться на внешние профили (`profiles/<id>.json`) и каталоги. Пользователь может сохранить/загрузить профиль как шаблон.

## 12. Валидация конфликтов

- При запуске проверяются противоречия (например, `sfw_level > 0.7` и `coverage_target < 0.3`). Система предлагает безопасный компромисс: повышает `coverage_target` до минимума 0.45, усиливает `fitness_body_focus` в мягких пределах.
- Конфликты и применённые коррекции логируются в `runs.conflicts` и выводятся пользователю.

## 13. Миграция и тестирование

- Скрипт миграции конвертирует существующие каталоги и SQLite в новые JSON/таблицы, сохраняя историю.
- Предусмотрены unit-тесты для парсинга стилей/персонажей, bias-движка, расчёта агрегатов, валидации конфликтов и миграций.

## 14. Acceptance criteria

- Pre-prompt собирается только из JSON стилей и персонажей + bias от профиля.
- Ollama получает макро/мезо сигналы и факты сцены, caption ≤ 2 предложений.
- Imagen результат и все метрики пишутся в БД с нормализованной схемой.
- Изменение макро/мезо весов смещает выбор опций (наблюдаемо в `gene_stats`/`prompts`).
- Профили содержат 10–12 регуляторов, микро метрики скрыты от пользователя.
- Dry-run выполняется без скоринга и опирается на замороженные профили.
- Конфликты параметров подсвечиваются и корректируются безопасно.

